<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal noUiSlider Date Test (V4 - Date Format Re-introduced)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 700px; margin: 20px auto; }
        #date-slider-minimal { margin: 40px 10px; }
        #slider-output { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background-color: #f9f9f9; border-radius: 4px; }
        .noUi-connect { background: #3498db; }
        .noUi-handle { border: 1px solid #D9D9D9; border-radius: 3px; background: #FFF; cursor: default; box-shadow: inset 0 0 1px #FFF, inset 0 1px 7px #EBEBEB, 0 3px 6px -3px #BBB; }
        .noUi-handle:before, .noUi-handle:after { content: ""; display: block; position: absolute; height: 14px; width: 1px; background: #E8E7E6; left: 14px; top: 6px; }
        .noUi-handle:after { left: 17px; }
        #formatted-dates-display span { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Minimal noUiSlider Date Test (V4 - Date Format Re-introduced)</h1>
        <p>Testing with date formatting in `format.to` and minimal other options.</p>
        <div id="date-slider-minimal"></div>
        <div id="slider-output">
            <p><strong>Log (see browser console):</strong></p>
            <div id="log-display">---</div>
            <hr>
            <p><strong>Formatted Date Range (from `format.to` - should be YYYY-MM-DD):</strong></p>
            <div id="formatted-dates-display">
                Start: <span id="formatted-start">---</span>, End: <span id="formatted-end">---</span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const DAY_IN_MILLISECONDS = 24 * 60 * 60 * 1000;
            const logDisplay = document.getElementById('log-display');

            const today = new Date();
            const maxTs = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate())).getTime();
            const twoYearsAgo = new Date(maxTs);
            twoYearsAgo.setUTCFullYear(twoYearsAgo.getUTCFullYear() - 2);
            const minTs = twoYearsAgo.getTime();
            const initialStartTs = minTs + (30 * DAY_IN_MILLISECONDS); // Example start
            const initialEndTs = maxTs - (30 * DAY_IN_MILLISECONDS);   // Example end
            const stepTs = DAY_IN_MILLISECONDS;

            const sliderElement = document.getElementById('date-slider-minimal');
            const formattedStartSpan = document.getElementById('formatted-start');
            const formattedEndSpan = document.getElementById('formatted-end');

            if (!sliderElement) { console.error("Slider element not found!"); return; }
            if (typeof noUiSlider === 'undefined') {
                logDisplay.innerHTML = "<p style='color:red;'><strong>Error: noUiSlider library not loaded.</strong></p>";
                return;
            }
            
            let formatToCallCount_V4 = 0; 

            // Define the update callback function separately
            const updateDisplayCallbackV4 = function (values, handle) {
                // values are now expected to be 'YYYY-MM-DD' strings from format.to
                formattedStartSpan.textContent = values[0]; 
                formattedEndSpan.textContent = values[1];
            };

            try {
                console.log(`[V4 PRE-CREATE] minTs: ${minTs}, maxTs: ${maxTs}, initialStartTs: ${initialStartTs}, initialEndTs: ${initialEndTs}, stepTs: ${stepTs}`);

                noUiSlider.create(sliderElement, {
                    start: [initialStartTs, initialEndTs],
                    connect: true,
                    behaviour: 'tap-drag',
                    step: stepTs,
                    range: {
                        'min': minTs,
                        'max': maxTs
                    },
                    format: {
                        to: function (value) {
                            formatToCallCount_V4++; 
                            console.log(`[V4 FORMAT.TO CALL #${formatToCallCount_V4}] Received value: ${value} (Type: ${typeof value})`);
                            
                            const valueAsFloat = parseFloat(value); 

                            if (!Number.isFinite(valueAsFloat)) { 
                                console.error(`[V4 FORMAT.TO CALL #${formatToCallCount_V4}] Original value ${value} parsed to non-finite float (${valueAsFloat}). Throwing.`);
                                throw new Error(`format.to (V4) received value that results in non-finite float: original='${value}', parsed='${valueAsFloat}'`);
                            }

                            // The date math, with robust error checking around it
                            try {
                                const roundedTimestamp = Math.round(valueAsFloat / DAY_IN_MILLISECONDS) * DAY_IN_MILLISECONDS;
                                if (!Number.isFinite(roundedTimestamp)) { // Check after rounding too
                                     console.error(`[V4 FORMAT.TO CALL #${formatToCallCount_V4}] Rounded timestamp became non-finite: ${roundedTimestamp} from value ${valueAsFloat}`);
                                     throw new Error(`format.to (V4) rounded timestamp non-finite for value: ${valueAsFloat}`);
                                }

                                const dateForFormatting = new Date(roundedTimestamp);
                                if (isNaN(dateForFormatting.getTime())) {
                                    console.error(`[V4 FORMAT.TO CALL #${formatToCallCount_V4}] new Date() from value ${valueAsFloat} (rounded: ${roundedTimestamp}) resulted in Invalid Date object.`);
                                    throw new Error(`format.to (V4) resulted in Invalid Date for value: ${valueAsFloat}, roundedTimestamp: ${roundedTimestamp}`);
                                }
                                const formattedDateString = dateForFormatting.toISOString().split('T')[0];
                                console.log(`[V4 FORMAT.TO CALL #${formatToCallCount_V4}] Successfully formatted to: ${formattedDateString}`);
                                return formattedDateString;
                            } catch (e) {
                                console.error(`[V4 FORMAT.TO CALL #${formatToCallCount_V4}] Error during date formatting for value ${valueAsFloat}:`, e.message);
                                throw e; 
                            }
                        },
                        from: function (value) { // Expects 'YYYY-MM-DD'
                            const time = new Date(value + 'T00:00:00Z').getTime();
                            return Number.isFinite(time) ? time : NaN;
                        }
                    }
                });

                sliderElement.noUiSlider.on('update', updateDisplayCallbackV4);
                
                const initialValuesV4 = sliderElement.noUiSlider.get();
                updateDisplayCallbackV4(initialValuesV4, null); 
                
                logDisplay.textContent = "Slider V4 initialized. Check console.";

            } catch (e) {
                console.error("Error creating noUiSlider (V4):", e);
                logDisplay.innerHTML = `<p style='color:red;'><strong>Error creating slider (V4):</strong> ${e.message}</p><pre>${e.stack}</pre>`;
            }
        });
    </script>
</body>
</html>